---
title: "Problem_Set_IV Due Date Monday April 3rd"
output: 
  html_document:
    toc: true # table of content true
    toc_depth: 2  # upto three depths of headings (specified by #, ## and ###)
    toc_float:
      collapsed: false
      smooth_scroll: false
    df_print: paged

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### We would like to include some instructions regarding submission of problem sets to be able to fairly, consistently and efficiently grade your assignments.

#### 1. Please submit just one document this document needs to be a .R script all the necessary text (answers, discussions, analysis) can be added to the script as comments (remember that a comment starts with the # symbol)

#### 2.Once you have solved a problem with the code and the result needs to be printed by just calling the variable created. For example, if you are calculating the mean of a distribution and save the result as variable a = mean(x) then the next line needs to be a call to a, either print(a) or just a, so that when we run the code to check on your work we can evaluate your responses correctly.

#### 3.The final answer needs to be written down as a comment; just having the final number as an answer will result in point deductions as in most cases the question is not asking for a number but for a statistical analysis. Eg. The t-test had a p-value of 0.001 t = 4.6 n = 30 (this is the correct way to present the results from a t-test, you can also include the 95CI), which indicates that we reject the null hypothesis that the mean blood pressure in treatment 1 is the same as in the placebo group.

#### 4.From now on, starting with Problem Set #2m we will not accept screenshots of code or results. You need to submit a single .R file.

#### 5.If there are plots in the results, you don’t need to print the plots using a different document, just have the code and we will run it and see the plot that you created.

#### 6.It is ok to work together and copy code from exercises, peers, class examples, etc, but it is not ok to copy identical workflows and answers from classmates. Copying another’s answers verbatim is considered plagiarism and will result in a zero for the assignment as well as other potential consequences according to Program and University guidelines.

#### 7.The penalty for turning in a late assignment is 10% reduction in grade per day (see course syllabus). 

### How long will a person live? The life expectancy dataset provided by WHO (World Health Organization) is an attempt to answer this question:

#### Independent Variables (predictors)

#### Adult.Mortality
#### infant.deaths
#### Alcohol
#### percentage.expenditure
#### Hepatitis.B
#### Measles
#### BMI
#### under.five.deaths
#### Polio
#### Total.expenditure
#### Diphtheria
#### HIV.AIDS
#### GDP
#### Population
#### Income.composition.of.resources
#### Schooling

### Outcome (dependent variable)

#### Life.expectancy 

## Problem Set 4 (100 points)

#### We are going to use the life expectancy dataset to generate a linear model that predicts life expectancy using the 16 predictors from the dataset

#### This data has been subsetted to include only continuous data.

```{r load}
expectancy = read.csv("Life_Expectancy_Data.csv")
```


#### Because this data contains missing data we are going to impute the dataset by using the means of each column. Imputation is the process of replacing missing data with some value. There are many techniques for imputation, but we are going to simply add the median of the column to each missing data, that way we wouldn’t be creating a statistical bias by skewing the distribution. 

```{r impute}
##mean imputation
for(i in 1:ncol(expectancy)) {
  expectancy[ , i][is.na(expectancy[ , i])] <- median(expectancy[ , i], na.rm=TRUE)
}
```

## Premise
### Your job for this assignment is to use the statistical tools seen in class to evaluate and find the best model (best predictors and their combination) that best explains the outcome variable. The assignment will be divided into three sections:

#### This exercise is open ended, no correct answer, so what are we looking for in the responses?:

## 1. Data Exploration (Introduction - Methods) (30 points)
### Do a short data exploration of this dataset. Describe the most problematic aspects of the data (deviations from normality, colliniearity, skewness, etc) that could potentially affect and bias the analysis.
```{r Q1}
library(ggplot2)
library(readr)
library(psych)
library(reshape2)

# Descriptive statistics for features
descriptive <- round(describe(expectancy),2)

# Loop through each statistic and format to avoid scientific notation for easier readability
for (col in names(descriptive)) {
  if (!is.factor(descriptive[[col]])) {
    descriptive[[col]] <- format(descriptive[[col]], scientific = FALSE)
  }
}

# Calculate correlation matrix
cormat <- cor(expectancy)
melted_cormat <- melt(cormat)

# Plot heat map of correlation matrix
ggplot(data = melted_cormat, aes(Var1, Var2, fill = value, label = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, 
                       limit = c(-1, 1), space = "Lab", name = "Pearson\nCorrelation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 8, hjust = 1)) +
  coord_fixed() +
  labs(title = "Correlation Heatmap")

# find correlation greater than 0.7
high_cor <- subset(melted_cormat, value > 0.7 & Var1 != Var2)

# Plot a histogram for each variable
for (var in names(expectancy)) {
  histograms <- ggplot(expectancy, aes_string(x = var)) +
    geom_histogram(bins = 30, fill = "cornflowerblue", color = "black") +
    theme_minimal() +
    ggtitle(paste("Distribution of", var))
  
  print(histograms)
}

# Scatterplots of variables that have outliers
ggplot(expectancy, aes(x = Life.expectancy, y = infant.deaths)) +
  geom_point() +
  labs(x = "Life Expectancy", y = "Infant Deaths", title = "Life Expectancy vs Infant Deaths") +
  theme_minimal()

ggplot(expectancy, aes(x = Life.expectancy, y = Measles)) +
  geom_point() +
  labs(x = "Life Expectancy", y = "Measles", title = "Life Expectancy vs Measles") +
  theme_minimal()


# Many variables exhibit significant skewness, which indicates a departure from the normal distribution. Variables adult mortality, infant death, percentage expenditure, measles, under five deaths, HIV/AIDS, GDP, Population, are significantly skewed to the right. Variables Hepatitis B, Polio, Diphtheria, and income composition of resources are significantly skewed to the left. This skewness is likely due to the presence of outliers or a long-tailed distribution. This skewness can affect statistical analyses, particularly those that assume a normal distribution of variables. The max values for  infant deaths, Measles, and under-five deaths are significantly higher than their respective 75th percentiles, suggesting the presence of outliers.

# Under five deaths and infant deaths have a high correlation (0.99), as do GDP and percentage expenditure (0.90), and schooling and income composition of resources (0.80). High correlations between independent variables can lead to multicollinearity in regression models, which might inflate the variance of the coefficient estimates and make the model less reliable.
```
## 2. Model Generation and Evaluation (Results) (35 points)
### Use the tools described in class to generate a linear model that best fits the data. Remember that there are different ways to evaluate and compare the models and you have to make the decisions based on the data you have. You should use the metrics, scores and diagnostic plots that help evaluate the models seen in class.
```{r Q2}
# Feature selection 
# removed columns to prevent colliniearity
features <- subset(expectancy, select = -c(under.five.deaths, percentage.expenditure, Income.composition.of.resources))

# Model Building
model <- lm(Life.expectancy ~ ., data = features)
summary(model)

par(mfrow=c(2,2))
plot(model)


```
## 3. Analysis and Discussion (Conclusions) (35 points)
### Generate a short report (a paragraph or two) about the main conclusions of your analysis, including the effect of the selected independent variables on life expectancy and under what criteria you chose those variables, and what is the interpretaion of the model you selected. Also, what kind of predictions and their utility you can make from your results.
```{r Q3}
# This statistical analysis via linear regression reveals critical determinants of life expectancy, focusing on healthcare and socio-economic factors. Significant predictors include Adult Mortality, Alcohol, Hepatitis B, Measles, BMI, Polio, Total Expenditure, Diphtheria, HIV/AIDS, and GDP, all with p-values < 0.05, indicating a statistically significant relationship with Life Expectancy at the 95% confidence level or higher. Population is not statistically significant (p-value > 0.05), suggesting its effect on life expectancy might not be a strong predictor when considering other factors in the model. With an R-squared value of approximately 80.12% and an adjusted R-squared value of approximately 80.04%, the model effectively explains the variance in life expectancy, highlighting education and healthcare as pivotal. These findings underscore the potential of targeted policies in education and healthcare to enhance life expectancy, offering a data-driven approach for prioritizing interventions and allocating resources effectively for public health improvements.

```


